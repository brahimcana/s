<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Client – Coursier Prioritaire</title>
  <style>
    body {
      background-color: #f1f1f1;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    nav {
      background-color: #2980b9;
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav a, nav button {
      color: white;
      text-decoration: none;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    main {
      padding: 20px;
    }
    .section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    /* تنسيق الجدول */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #2980b9;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    /* أزرار وألوان */
    .btn-calc {
      width: 100%;
      padding: 10px;
      background-color: #f39c12;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .btn-calc:hover {
      background-color: #d78c0c;
    }
    .btn-create {
      width: 100%;
      padding: 10px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .btn-create:hover {
      background-color: #219654;
    }
    .txt-link {
      color: #2980b9;
      text-decoration: none;
      cursor: pointer;
    }
    .txt-link:hover {
      text-decoration: underline;
    }
    .btn-cancel {
      background: none;
      border: none;
      color: #c0392b;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-cancel:hover {
      text-decoration: underline;
    }
    .message {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
    }
    /* تصميم متجاوب */
    @media (max-width: 600px) {
      table, th, td {
        font-size: 12px;
      }
      .btn-calc, .btn-create {
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <!-- Nav -->
  <nav>
    <div>
      <a href="index.html">← Accueil</a>
    </div>
    <div>
      <button id="btnLogout">Déconnexion</button>
    </div>
  </nav>

  <main>
    <!-- قسم 1: إنشاء طلب جديد -->
    <section class="section">
      <h2>Créer une nouvelle commande</h2>
      <div id="alert-create" class="message"></div>
      <form id="createForm">
        <label>Adresse de départ</label>
        <input type="text" id="from" placeholder="Ex : 10 Rue Esquirol, Toulouse" required />
        <label>Adresse de livraison</label>
        <input type="text" id="to" placeholder="Ex : 15 Rue Peyrolières, Toulouse" required />
        <label>Distance (km)</label>
        <input type="number" step="0.1" id="km" placeholder="Ex : 2.5" required />
        <div style="margin-top:8px;">
          <input type="checkbox" id="urgent" /> <label for="urgent">Urgent (+ tarif)</label>
        </div>
        <div id="fee-display" style="margin-top: 10px; font-weight: bold;"></div>
        <button type="button" class="btn-calc" id="btnCalcFee">Calculer le tarif</button>
        <button type="submit" class="btn-create" id="btnCreate">Créer et payer</button>
      </form>
    </section>

    <!-- قسم 2: جدول الطلبات -->
    <section class="section">
      <h2>Mes commandes</h2>
      <div id="alert-orders" class="message"></div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Tarif (€)</th>
              <th>Statut</th>
              <th>Paiement</th>
              <th>Détails</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzBLlXlwArIS1KrZDJNIJPpn1cfgA0YJSZxz5fs25jB64ngEMp3hMatf7hSPVashceG/exec";
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || "null");
    if (!currentUser || currentUser.role !== 'client') {
      window.location.href = 'login.html';
    }
    const clientEmail = currentUser.email;
    const clientToken = currentUser.token;

    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // 1) تحميل الطلبات عند فتح الصفحة
    async function loadClientOrders() {
      const formData = new FormData();
      formData.append('path', 'getRequestsByClientId');
      formData.append('email', clientEmail);
      formData.append('token', clientToken);

      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        const data = await res.json();
        const tbody = document.getElementById('ordersTable');
        tbody.innerHTML = '';
        if (data.success) {
          data.orders.forEach(order => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${order.id}</td>
              <td>${order.type || '—'}</td>
              <td>${order.fee}</td>
              <td>${order.status}</td>
              <td>${order.paymentStatus}</td>
              <td>
                <a class="txt-link" href="order-details.html?orderId=${order.id}">Voir</a>
              </td>
              <td>
                ${(order.status === 'Unassigned' && order.paymentStatus === 'paid')
                  ? `<button class="btn-cancel" onclick="cancelOrder(${order.id})">Annuler</button>`
                  : `—`
                }
              </td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          document.getElementById('alert-orders').innerHTML = `<div style="color:red;">${data.message}</div>`;
        }
      } catch {
        document.getElementById('alert-orders').innerHTML = `<div style="color:red;">Erreur réseau</div>`;
      }
    }

    // دالة إلغاء الطلب
    async function cancelOrder(orderId) {
      const formData = new FormData();
      formData.append('path', 'cancelRequest');
      formData.append('email', clientEmail);
      formData.append('token', clientToken);
      formData.append('requestId', orderId);

      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          document.getElementById('alert-orders').innerHTML = `<div style="color:green;">${data.message}</div>`;
          loadClientOrders();
        } else {
          document.getElementById('alert-orders').innerHTML = `<div style="color:red;">${data.message}</div>`;
        }
      } catch {
        document.getElementById('alert-orders').innerHTML = `<div style="color:red;">Erreur réseau</div>`;
      }
    }

    // 2) حساب التكلفة
    document.getElementById('btnCalcFee').addEventListener('click', async () => {
      const km = parseFloat(document.getElementById('km').value);
      const urgent = document.getElementById('urgent').checked;
      const alertCreate = document.getElementById('alert-create');
      alertCreate.innerHTML = '';
      if (isNaN(km) || km <= 0) {
        alertCreate.innerHTML = `<div style="color:red;">Entrez une distance valide.</div>`;
        return;
      }

      const formData = new FormData();
      formData.append('path', 'calculateFee');
      formData.append('email', clientEmail);
      formData.append('token', clientToken);
      formData.append('type', 'purchase');
      formData.append('urgent', urgent ? 'true' : 'false');

      try {
        const res = await fetch(API_URL, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          document.getElementById('fee-display').textContent = `Tarif estimé : ${data.fee.toFixed(2)} €`;
        } else {
          alertCreate.innerHTML = `<div style="color:red;">Erreur calcul tarif.</div>`;
        }
      } catch {
        alertCreate.innerHTML = `<div style="color:red;">Erreur réseau</div>`;
      }
    });

    // 3) إنشاء الطلب
    document.getElementById('createForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const from = document.getElementById('from').value.trim();
      const to = document.getElementById('to').value.trim();
      const km = parseFloat(document.getElementById('km').value);
      const urgent = document.getElementById('urgent').checked;
      const alertCreate = document.getElementById('alert-create');
      alertCreate.innerHTML = '';

      if (!from || !to || isNaN(km) || km <= 0) {
        alertCreate.innerHTML = `<div style="color:red;">Tous les champs sont requis.</div>`;
        return;
      }

      try {
        // حساب التكلفة
        const calcData = new FormData();
        calcData.append('path', 'calculateFee');
        calcData.append('email', clientEmail);
        calcData.append('token', clientToken);
        calcData.append('type', 'purchase');
        calcData.append('urgent', urgent ? 'true' : 'false');

        const resCalc = await fetch(API_URL, { method: 'POST', body: calcData });
        const dataCalc = await resCalc.json();
        if (!dataCalc.success) {
          alertCreate.innerHTML = `<div style="color:red;">Erreur calcul tarif.</div>`;
          return;
        }
        const fee = dataCalc.fee;

        // إنشاء PaymentIntent
        const piData = new FormData();
        piData.append('path', 'createPaymentIntent');
        piData.append('email', clientEmail);
        piData.append('token', clientToken);
        piData.append('amount', fee);
        piData.append('currency', 'eur');
        piData.append('clientEmail', clientEmail);

        const resPi = await fetch(API_URL, { method: 'POST', body: piData });
        const dataPi = await resPi.json();
        if (!dataPi.clientSecret) {
          alertCreate.innerHTML = `<div style="color:red;">Impossible de créer PaymentIntent.</div>`;
          return;
        }

        alertCreate.innerHTML = `<div style="color:green;">Paiement simulé réussi. Création de la commande...</div>`;

        // إنشاء الطلب
        const orderData = new FormData();
        orderData.append('path', 'createRequest');
        orderData.append('email', clientEmail);
        orderData.append('token', clientToken);
        orderData.append('type', 'purchase');
        orderData.append('description', '—');
        orderData.append('pickupAddress', from);
        orderData.append('deliveryAddress', to);
        orderData.append('urgent', urgent ? 'true' : 'false');
        orderData.append('latitudePU', '0');
        orderData.append('longitudePU', '0');
        orderData.append('latitudeDO', '0');
        orderData.append('longitudeDO', '0');
        orderData.append('paymentIntentId', dataPi.paymentIntentId);

        const resOrder = await fetch(API_URL, { method: 'POST', body: orderData });
        const dataOrder = await resOrder.json();
        if (dataOrder.success) {
          alertCreate.innerHTML = `<div style="color:green;">Commande créée (ID : ${dataOrder.requestId}).</div>`;
          loadClientOrders();
        } else {
          alertCreate.innerHTML = `<div style="color:red;">Erreur création commande.</div>`;
        }
      } catch {
        alertCreate.innerHTML = `<div style="color:red;">Erreur réseau</div>`;
      }
    });

    loadClientOrders();
  </script>
</body>
</html>
